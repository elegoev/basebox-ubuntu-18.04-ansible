{
  "variables": {
    "src_image_name": "elegoev/ubuntu-18.04",
    "src_image_version": "2.0.1609256225",
    "image_name": "ubuntu-18.04-ansible",
    "image_version": "2.0.{{timestamp}}",
    "cloud_token": "{{ env `PACKER_VAGRANTCLOUD_TOKEN` }}"
  },
  "builders": [
    {
      "communicator": "ssh",
      "source_path": "{{user `src_image_name`}}",
      "box_version": "{{user `src_image_version`}}",
      "output_dir": "packer_build_dir",
      "box_name": "basebox-{{user `image_name`}}",
      "provider": "virtualbox",
      "add_force": true,
      "type": "vagrant"
    }
  ],
  "provisioners": [
    {
      "type": "shell",
      "script": "./packer/provisioners/base-provisioning.sh"
    },
    {
      "type": "inspec",
      "inspec_env_vars": [ "CHEF_LICENSE=accept"],
      "extra_arguments": [ "--reporter", "cli", "html2:./inspec/inspec_html_report/baseline-{{user `image_name`}}_report.html" ],
      "profile": "./inspec/baseline-ubuntu-18.04-ansible"
    }
  ],
  "post-processors": [
    {
      "type": "shell-local",
      "environment_vars": ["IMAGE_NAME={{user `image_name`}}"],
      "execute_command": ["powershell.exe", "{{.Vars}} {{.Script}}"],
      "env_var_format": "$env:%s=\"%s\"; ",
      "script": "./packer/post-processors/vagrant-cloud-create-box.ps1"  
    },
    {
      "type": "shell-local",
      "environment_vars": ["IMAGE_VERSION={{user `image_version`}}"],
      "execute_command": ["powershell.exe", "{{.Vars}} {{.Script}}"],
      "env_var_format": "$env:%s=\"%s\"; ",
      "script": "./packer/post-processors/create-git-tag.ps1"  
    },
    {
      "type": "vagrant-cloud",
      "box_tag": "elegoev/{{user `image_name`}}",
      "version": "{{user `image_version`}}",
      "version_description": "***\n[[github info]](https://github.com/elegoev/basebox-ubuntu-18.04-ansible/tree/{{user `image_version`}})[[inspec report]](https://htmlpreview.github.io/?https://github.com/elegoev/basebox-ubuntu-18.04-ansible/blob/{{user `image_version`}}/inspec/inspec_html_report/baseline-ubuntu-18.04-ansible_report.html)[[basebox elegoev/ubuntu-18.04]](https://app.vagrantup.com/elegoev/boxes/ubuntu-18.04/versions/{{user `src_image_version`}})",
      "access_token": "{{user `cloud_token`}}"
    },
    {
      "type": "shell-local",
      "execute_command": ["powershell.exe", "{{.Vars}} {{.Script}}"],
      "env_var_format": "$env:%s=\"%s\"; ",
      "script": "./packer/post-processors/cleanup.ps1"  
    }
  ],
  "error-cleanup-provisioner": {
    "type": "shell-local",
    "execute_command": ["powershell.exe", "{{.Vars}} {{.Script}}"],
    "env_var_format": "$env:%s=\"%s\"; ",
    "script": "./packer/error-cleanup-provisioner.ps1"  
  }
}
